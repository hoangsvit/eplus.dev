---
title: "HTTPS Content-Based Load Balancer with Terraform - GSP206"
seoTitle: "HTTPS Content-Based Load Balancer with Terraform - GSP206"
seoDescription: "In this lab, you will create an HTTPS load balancer to forward traffic to a custom URL map. The URL map sends traffic to the region closest to you with stat"
datePublished: Mon Aug 26 2024 03:30:23 GMT+0000 (Coordinated Universal Time)
cuid: cm0afxdpy00060alca7xa6kms
slug: https-content-based-load-balancer-with-terraform-gsp206
cover: https://cdn.hashnode.com/res/hashnode/image/upload/v1724723482120/5494c355-76bd-4b02-a9f4-e3bb00a62e01.jpeg
ogImage: https://cdn.hashnode.com/res/hashnode/image/upload/v1724643009532/9fbb3b4b-956a-4d15-a797-e8572b590c21.png
tags: https-content-based-load-balancer-with-terraform-gsp206, gsp206

---

## **Overview**

In this lab, you will create an HTTPS load balancer to forward traffic to a custom URL map. The URL map sends traffic to the region closest to you with static assets being served from a Cloud Storage bucket. The TLS key and certificate is generated by Terraform using the [TLS provider](https://www.terraform.io/docs/providers/tls/index.html).

The following is a diagram of the architecture you will be creating:

![The Terraform Architecture, including the Cloud Load Balancing, three instances, and Cloud Storage.](https://cdn.qwiklabs.com/8BAGcQptix4GVZGtF1UCJxH7rjKvaLjx5y5lgXBCwSk%3D align="left")

## **Objectives**

In this lab, you will:

* Learn about the load balancing modules for Terraform
    
* Configure Terraform in the Google Cloud environment
    
* Create a global HTTPS Content-Based Load Balancer
    

## **Setup and requirements**

### Before you click the Start Lab button

Read these instructions. Labs are timed and you cannot pause them. The timer, which starts when you click **Start Lab**, shows how long Google Cloud resources will be made available to you.

This hands-on lab lets you do the lab activities yourself in a real cloud environment, not in a simulation or demo environment. It does so by giving you new, temporary credentials that you use to sign in and access Google Cloud for the duration of the lab.

To complete this lab, you need:

* Access to a standard internet browser (Chrome browser recommended).
    

**Note:** Use an Incognito or private browser window to run this lab. This prevents any conflicts between your personal account and the Student account, which may cause extra charges incurred to your personal account.

* Time to complete the lab---remember, once you start, you cannot pause a lab.
    

**Note:** If you already have your own personal Google Cloud account or project, do not use it for this lab to avoid extra charges to your account.

### How to start your lab and sign in to the Google Cloud console

1. Click the **Start Lab** button. If you need to pay for the lab, a pop-up opens for you to select your payment method. On the left is the **Lab Details** panel with the following:
    
    * The **Open Google Cloud console** button
        
    * Time remaining
        
    * The temporary credentials that you must use for this lab
        
    * Other information, if needed, to step through this lab
        
2. Click **Open Google Cloud console** (or right-click and select **Open Link in Incognito Window** if you are running the Chrome browser).
    
    The lab spins up resources, and then opens another tab that shows the **Sign in** page.
    
    ***Tip:*** Arrange the tabs in separate windows, side-by-side.
    
    **Note:** If you see the **Choose an account** dialog, click **Use Another Account**.
    
3. If necessary, copy the **Username** below and paste it into the **Sign in** dialog.
    
    ```apache
    student-04-73afd4b68bfe@qwiklabs.net
    ```
    
    You can also find the **Username** in the **Lab Details** panel.
    
4. Click **Next**.
    
5. Copy the **Password** below and paste it into the **Welcome** dialog.
    
    ```apache
    bnUFjlqttBKI
    ```
    
    You can also find the **Password** in the **Lab Details** panel.
    
6. Click **Next**.
    
    **Important:** You must use the credentials the lab provides you. Do not use your Google Cloud account credentials.
    
    **Note:** Using your own Google Cloud account for this lab may incur extra charges.
    
7. Click through the subsequent pages:
    
    * Accept the terms and conditions.
        
    * Do not add recovery options or two-factor authentication (because this is a temporary account).
        
    * Do not sign up for free trials.
        

After a few moments, the Google Cloud console opens in this tab.

**Note:** To view a menu with a list of Google Cloud products and services, click the **Navigation menu** at the top-left.

![Navigation menu icon](https://cdn.qwiklabs.com/nUxFb6oRFr435O3t6V7WYJAjeDFcrFb16G9wHWp5BzU%3D align="left")

### Activate Cloud Shell

Cloud Shell is a virtual machine that is loaded with development tools. It offers a persistent 5GB home directory and runs on the Google Cloud. Cloud Shell provides command-line access to your Google Cloud resources.

1. Click **Activate Cloud Shell**
    
    ![Activate Cloud Shell icon](https://cdn.qwiklabs.com/ep8HmqYGdD%2FkUncAAYpV47OYoHwC8%2Bg0WK%2F8sidHquE%3D align="left")
    
    at the top of the Google Cloud console.
    

When you are connected, you are already authenticated, and the project is set to your **Project\_ID**, `qwiklabs-gcp-00-193596bba74f`. The output contains a line that declares the **Project\_ID** for this session:

```apache
Your Cloud Platform project in this session is set to qwiklabs-gcp-00-193596bba74f
```

`gcloud` is the command-line tool for Google Cloud. It comes pre-installed on Cloud Shell and supports tab-completion.

2. (Optional) You can list the active account name with this command:
    

```apache
gcloud auth list
```

3. Click **Authorize**.
    

**Output:**

```apache
ACTIVE: *
ACCOUNT: student-04-73afd4b68bfe@qwiklabs.net

To set the active account, run:
    $ gcloud config set account `ACCOUNT`
```

4. (Optional) You can list the project ID with this command:
    

```apache
gcloud config list project
```

**Output:**

```apache
[core]
project = qwiklabs-gcp-00-193596bba74f
```

**Note:** For full documentation of `gcloud`, in Google Cloud, refer to [the gcloud CLI overview guide](https://cloud.google.com/sdk/gcloud).

## **Task 1. Clone the sample repository**

1. In Cloud Shell, clone the `terraform-google-lb-http` repository:
    

```apache
git clone https://github.com/GoogleCloudPlatform/terraform-google-lb-http.git
```

2. Navigate to the `multi-backend-multi-mig-bucket-https-lb` directory:
    

```apache
cd ~/terraform-google-lb-http/examples/multi-backend-multi-mig-bucket-https-lb
```

3. On the Cloud Shell toolbar, click the **Open Editor** icon.
    
4. Open the file `examples/multi-backend-multi-mig-bucket-https-lb/main.tf`.
    
5. On line 133, inside the `gce-lb-https` module, add the following lines:
    

```apache
create_ssl_certificate = true
managed_ssl_certificate_domains = ["example.com"]
```

6. In the `examples/multi-backend-multi-mig-bucket-https-lb/variables.tf` file, update the region definitions to the following:
    
    * **group1\_region** = `us-west1`
        
    * **group2\_region** = `europe-west1`
        
    * **group3\_region** = `us-east4`
        

## **Task 2. Run Terraform**

### Initialize a working directory

The `terraform init` command is used to initialize a working directory containing Terraform configuration files. This command performs several different initialization steps to prepare a working directory for use. This command is always safe to run multiple times, to bring the working directory up to date with changes in the configuration.

* Run the command:
    

```apache
terraform init
```

**Example output:**

```apache
...
Terraform has been successfully initialized!
```

### Create an execution plan

The `terraform plan` command is used to create an execution plan. Terraform performs a refresh, unless explicitly disabled, and then determines what actions are necessary to achieve the desired state specified in the configuration files.

This command is a convenient way to check whether the execution plan for a set of changes matches your expectations without making any changes to real resources or the state. For example, `terraform plan` might be run before committing a change to version control, to create confidence that it will behave as expected.

1. Run the following command to create an execution plan:
    

```apache
terraform plan -out=tfplan -var 'project=qwiklabs-gcp-00-193596bba74f'
```

**Example output:**

```apache
...
Plan: 42 to add, 0 to change, 0 to destroy.
```

The optional `-out` argument can be used to save the generated plan to a file for later execution with `terraform apply`.

2. List out current directory content. You will see the saved Terraform plan (`tfplan`):
    

```apache
ls
```

**Example output:**

```apache
diagram.png  gceme.sh.tpl  gcp-logo.svg  main.tf  mig.tf  outputs.tf  README.md  test.sh  tfplan  tls.tf  variables.tf
```

### Apply the changes

The `terraform apply` command is used to apply the changes required to reach the desired state of the configuration, or the pre-determined set of actions generated by a terraform plan execution plan.

1. Apply the Terraform plan:
    

```apache
terraform apply tfplan
```

**Example output (yours will differ):**

```apache
...
Apply complete! Resources: 42 added, 0 changed, 0 destroyed.
...
Outputs:

asset-url = https://34.96.112.153/assets/gcp-logo.svg group1_region = us-west1 group2_region = us-central1 group3_region = us-east1 load-balancer-ip = 34.96.112.153 
```

Verify the resources created by Terraform:

2. In the Navigation menu navigate to **Network services** &gt; **Load Balancing**.
    
3. Wait until you see the green checkmark in the Backends column.
    
4. Click on **ml-bk-ml-mig-bkt-s-lb** load balancer and check the details.
    

![Load Balancer Frontend listing the available details, including the various protocols, hosts, and path rules.](https://cdn.qwiklabs.com/qQJmbqMRX0tkIC7Y7NMu0DTD7I6KAEg89WJV2dLA4u0%3D align="left")

![Load Balancer Backend listing the backend services and bucktes, each include items such as Type, Zone, and Capacity.](https://cdn.qwiklabs.com/6uEToq0a6IAMTjlqiRbnyK299HzfLSfXDby5sZTEMVY%3D align="left")

5. Run the following to get the external URL:
    

```apache
EXTERNAL_IP=$(terraform output | grep load-balancer-ip | cut -d = -f2 | xargs echo -n)
```

```apache
echo https://${EXTERNAL_IP}
```

6. Click on the `EXTERNAL_IP` link that is returned to open the load balancer URL in a new browser tab. It will take a few minutes to load.
    

**Note:** If you don't get the expected output in the browser, make sure your load balancer details panel is the same as an above screenshot and wait for few minutes.

**Note:** If you get a privacy error, click on **Advanced** and then **proceed.**

You should see the Google Cloud logo and instance details from the group closest to your geographical region.

![Google Cloud instance details such as Name, Zone, Machine Type, and Internal IP.](https://cdn.qwiklabs.com/PTIvWseLPEfR9rGTyauAvDQLdwdvvkfUXaUkALsJCw8%3D align="left")

Click **Check my progress** to verify the objective.

Apply the changes in Terraform

**Check my progress**

7. Now append the URL with `group1`, `group2` and `group3`.
    

Your final URLs should look like (make sure to replace `EXTERNAL_IP` with your load balancer IP):`https://EXTERNAL_IP/group1`

* For `group1`: You should see the Google Cloud logo and instance details from the group in `us-west1`.
    

`https://EXTERNAL_IP/group2`

* For `group2`: You should see the Google Cloud logo and instance details from the group in `europe-west1`
    

`https://EXTERNAL_IP/group3`

* For `group3`: You should see the Google Cloud logo and instance details from the group in `us-east4`
    

---

## Solution of Lab

%[https://www.youtube.com/watch?v=_8HsePy4JVw] 

```apache
curl -LO raw.githubusercontent.com/quiccklabs/Labs_solutions/master/HTTPS%20Content-Based%20Load%20Balancer%20with%20Terraform/quicklabgsp206.sh
sudo chmod +x quicklabgsp206.sh
./quicklabgsp206.sh
```